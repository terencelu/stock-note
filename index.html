<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>投資收益</title>
    <style>
        :root {
            --primary-bg: #f4f7f6;
            --card-bg: #ffffff;
            --accent-blue: #007AFF;
            --accent-red: #FF3B30;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--primary-bg);
            margin: 0; padding: 10px;
            display: flex; justify-content: center;
            user-select: none; -webkit-user-select: none;
        }

        .container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { text-align: center; margin: 10px 0; color: #333; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 12px 2px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        
        .val-cell {
            background: #f9f9f9;
            border-radius: 6px;
            font-weight: 500;
            color: var(--accent-blue);
            height: 38px;
            line-height: 38px;
            position: relative;
        }

        .cell-input {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: 2px solid var(--accent-blue);
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
            display: none;
            box-sizing: border-box;
            background: white;
            z-index: 10;
        }

        .total-row { background: #eee; font-weight: bold; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; margin-top: 10px; color: white; cursor: pointer; }
        .save-btn { background: var(--accent-blue); }
        .clear-btn { background: var(--accent-red); }
    </style>
</head>
<body>

<div class="container">
    <h2>年度收益</h2>
    <table>
        <thead>
            <tr><th style="width: 20%;">月份</th><th>配息</th><th>獲利</th><th>小計</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr class="total-row"><td>總計</td><td id="t-div">0</td><td id="t-prof">0</td><td id="t-all">0</td></tr>
        </tfoot>
    </table>
    <button id="saveBtn" class="btn save-btn">長按儲存</button>
    <button id="clearBtn" class="btn clear-btn">長按清空</button>
</div>

<script>
    // 1. 初始化資料結構：List<List>
    // 結構：[[div, prof], [div, prof], ...] 共 12 個子陣列
    let monthlyData = Array.from({ length: 12 }, () => [0, 0]);

    const tableBody = document.getElementById('tableBody');

    // 2. 生成表格
    for (let i = 0; i < 12; i++) {
        tableBody.innerHTML += `
            <tr>
                <td>${i + 1}月</td>
                <td class="val-cell" data-m="${i}" data-type="0">
                    <span class="display-val">0</span>
                    <input type="text" inputmode="decimal" class="cell-input">
                </td>
                <td class="val-cell" data-m="${i}" data-type="1">
                    <span class="display-val">0</span>
                    <input type="text" inputmode="decimal" class="cell-input">
                </td>
                <td id="sub-${i}" style="font-weight:bold">0</td>
            </tr>`;
    }

    // 3. 格式檢查與更新
    function updateData(monthIdx, typeIdx, value) {
        // 格式檢查：只允許數字與小數點
        let cleanValue = value.replace(/[^0-9.]/g, '');
        const num = parseFloat(cleanValue) || 0;
        
        // 更新陣列
        monthlyData[monthIdx][typeIdx] = num;
        
        // 更新顯示
        const cell = document.querySelectorAll(`tr`)[monthIdx + 1].querySelectorAll('.val-cell')[typeIdx];
        cell.querySelector('.display-val').innerText = num.toLocaleString();
        
        calculateTotals();
    }

    function calculateTotals() {
        let dSum = 0, pSum = 0;
        monthlyData.forEach((row, i) => {
            const rowTotal = row[0] + row[1];
            document.getElementById(`sub-${i}`).innerText = rowTotal.toLocaleString();
            dSum += row[0];
            pSum += row[1];
        });
        document.getElementById('t-div').innerText = dSum.toLocaleString();
        document.getElementById('t-prof').innerText = pSum.toLocaleString();
        document.getElementById('t-all').innerText = (dSum + pSum).toLocaleString();
    }

    // 4. 事件綁定 (長按邏輯)
    document.querySelectorAll('.val-cell').forEach(cell => {
        let t;
        const input = cell.querySelector('.cell-input');
        const mIdx = parseInt(cell.dataset.m);
        const tIdx = parseInt(cell.dataset.type);

        const start = () => t = setTimeout(() => {
            input.style.display = 'block';
            input.value = monthlyData[mIdx][tIdx] || "";
            input.focus();
            input.select();
        }, 600);

        const stop = () => clearTimeout(t);

        cell.addEventListener('touchstart', start);
        cell.addEventListener('touchend', stop);
        cell.addEventListener('mousedown', start);
        cell.addEventListener('mouseup', stop);

        input.addEventListener('blur', () => {
            updateData(mIdx, tIdx, input.value);
            input.style.display = 'none';
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') input.blur();
        });
    });

    // 5. 儲存與載入 (Local Storage 直接存陣列)
    const handleLongPressBtn = (id, action) => {
        let t;
        const el = document.getElementById(id);
        el.addEventListener('touchstart', () => t = setTimeout(action, 800));
        el.addEventListener('touchend', () => clearTimeout(t));
        el.addEventListener('mousedown', () => t = setTimeout(action, 800));
        el.addEventListener('mouseup', () => clearTimeout(t));
    };

    handleLongPressBtn('saveBtn', () => {
        localStorage.setItem('invest_list_data', JSON.stringify(monthlyData));
        alert('✅ 資料(陣列格式)已儲存');
    });

    handleLongPressBtn('clearBtn', () => {
        if(confirm('確定清空？')) {
            localStorage.removeItem('invest_list_data');
            location.reload();
        }
    });

    window.onload = () => {
        const saved = localStorage.getItem('invest_list_data');
        if (saved) {
            monthlyData = JSON.parse(saved);
            // 重新渲染畫面
            monthlyData.forEach((row, mIdx) => {
                const cells = document.querySelectorAll(`tr`)[mIdx + 1].querySelectorAll('.val-cell');
                cells[0].querySelector('.display-val').innerText = row[0].toLocaleString();
                cells[1].querySelector('.display-val').innerText = row[1].toLocaleString();
            });
            calculateTotals();
        }
    };
</script>
</body>
</html>